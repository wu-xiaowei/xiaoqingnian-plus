(window.webpackJsonp=window.webpackJsonp||[]).push([[351],{655:function(a,t,s){"use strict";s.r(t);var e=s(4),n=Object(e.a)({},(function(){var a=this,t=a._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[t("h1",{attrs:{id:"我竟被这个-bug-坑了一周"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#我竟被这个-bug-坑了一周"}},[a._v("#")]),a._v(" 我竟被这个 Bug 坑了一周！")]),a._v(" "),t("blockquote",[t("p",[a._v("本文作者："),t("a",{attrs:{href:"https://yuyuanweb.feishu.cn/wiki/Abldw5WkjidySxkKxU2cQdAtnah",target:"_blank",rel:"noopener noreferrer"}},[a._v("程序员鱼皮"),t("OutboundLink")],1)]),a._v(" "),t("p",[a._v("本站地址："),t("a",{attrs:{href:"https://codefather.cn",target:"_blank",rel:"noopener noreferrer"}},[a._v("https://codefather.cn"),t("OutboundLink")],1)])]),a._v(" "),t("blockquote",[t("p",[a._v("记录下来，下次秒解")])]),a._v(" "),t("p",[a._v("大家好，我是鱼皮，昨天解决了一个让我头疼了一周的 Bug，爽的不行！记录下来分享给大家，如果你们之后也遇到了这个 Bug，说不定就能轻松干掉它了。")]),a._v(" "),t("h3",{attrs:{id:"孽起"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#孽起"}},[a._v("#")]),a._v(" 孽起")]),a._v(" "),t("p",[a._v("事情是这样的，我在公司负责数据可视化相关项目，就是有个网站可以展示各种数据图表，便于分析数据。结果上周有一天，产品小姐姐说，她在系统上输入了两个不同的数据筛选条件，竟然查询出了一模一样的结果？")]),a._v(" "),t("p",[a._v("举个例子，她想分别查询一班和二班的学生成绩，结果无论指定查询条件是一班还是二班，查出的结果都是一班的！")]),a._v(" "),t("p",[t("img",{staticClass:"lazy",attrs:{alt:"","data-src":"https://pic.yupi.icu/5563/202311072029653.png",loading:"lazy"}})]),a._v(" "),t("blockquote",[t("p",[a._v("查询数据")])]),a._v(" "),t("p",[a._v("我还是第一次在我们的系统中遇到这样的 Bug，那就排查一下呗！")]),a._v(" "),t("h3",{attrs:{id:"排查"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#排查"}},[a._v("#")]),a._v(" 排查")]),a._v(" "),t("p",[a._v("让我们从前端开始查起，完整地追溯一个查询请求。")]),a._v(" "),t("p",[a._v("首先打开浏览器控制台，查看请求参数，发现班级的查询条件（1 或者 2）的确发送给后端了：")]),a._v(" "),t("p",[t("img",{staticClass:"lazy",attrs:{alt:"","data-src":"https://pic.yupi.icu/5563/202311072029366.png",loading:"lazy"}})]),a._v(" "),t("blockquote",[t("p",[a._v("查看请求参数")])]),a._v(" "),t("p",[a._v("好吧，那就是后端的问题，为什么不同的条件能查出相同的结果呢？")]),a._v(" "),t("p",[a._v("难道是后端没有用到这些条件？")]),a._v(" "),t("p",[t("img",{staticClass:"lazy",attrs:{alt:"","data-src":"https://pic.yupi.icu/5563/202311072029655.png",loading:"lazy"}})]),a._v(" "),t("p",[a._v("由于数据都是从数据库中查询出来的，那不妨看一下两种请求对应的 SQL（数据库查询语言）语句是否一致。")]),a._v(" "),t("p",[a._v("查一班学生成绩的 SQL：")]),a._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("select 班级,姓名,成绩 \nfrom student\nwhere 班级 = '一班';\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br")])]),t("p",[a._v("查二班学生成绩的 SQL：")]),a._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("select 班级,姓名,成绩 \nfrom student\nwhere 班级 = '二班';\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br")])]),t("p",[a._v("显然，上述两个查询语句不一致，已经把班级拼接到了 SQL 的 where 子句中。")]),a._v(" "),t("p",[a._v("然后我直接用数据库客户端去执行这两个语句，结果是不同的，能查到二班的数据。也就是说，不是数据库和查询语句的问题。")]),a._v(" "),t("p",[a._v("那奇怪了，如果从数据库中查到的数据是二班的，为什么最后返回给前端却是一班的呢？")]),a._v(" "),t("p",[t("img",{staticClass:"lazy",attrs:{alt:"","data-src":"https://pic.yupi.icu/5563/202311072029966.png",loading:"lazy"}})]),a._v(" "),t("p",[a._v("难道是系统对数据库中查出的数据又进行了后续处理，把二班变成了一班？")]),a._v(" "),t("p",[a._v("仔细看了下代码，也没有，我怎么会写出这么神奇的逻辑哈哈哈！")]),a._v(" "),t("p",[a._v("等等，难道说，数据根本不是从数据库取出来的，而是从数据库的上游 —— 缓存中读取的？")]),a._v(" "),t("p",[a._v("为了提高系统性能，我添加了缓存逻辑，将每个对数据库的查询语句、查询条件等放在一起进行计算，得到一个 key 字符串，并保证相同的查询语句 key 一定相同。")]),a._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("key = 计算(sql, 条件)\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br")])]),t("p",[a._v("也就是说，只要用户执行 SQL 从数据库中取过一次数据，就可以把 key 和结果保存起来。第二次再执行同样的查询，就能直接从缓存中取到结果，不用再到数据库中查啦。")]),a._v(" "),t("p",[a._v("但是，按道理来说，查询一班和二班的 SQL 是不同的，生成的 key 也理应不同，肯定不会查到同一份缓存数据啊？难不成我计算 key 的函数写错，导致出现相同的 key 碰撞了？")]),a._v(" "),t("p",[a._v("于是，我在自己的电脑上运行了计算 key 的函数，发现 key 的确是不同的：")]),a._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("# 查询一班的 SQL 算出的 Key：\nprefix:1234567\n\n# 查询二班的 SQL 算出的 Key：\nprefix:7654321\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br"),t("span",{staticClass:"line-number"},[a._v("4")]),t("br"),t("span",{staticClass:"line-number"},[a._v("5")]),t("br")])]),t("p",[a._v("既然本地和线上是同一组 SQL、同一个计算函数，所以本地的 key 不同，线上的 key 肯定也不同，那怎么还会查出相同的数据呢？好气啊！这不科学啊！")]),a._v(" "),t("p",[a._v("好吧，脑补分析一波后，没有结果。正好当时需求又比较多，于是我决定后面再解决这个 Bug，但它始终让我耿耿于怀。")]),a._v(" "),t("p",[t("img",{staticClass:"lazy",attrs:{alt:"","data-src":"https://pic.yupi.icu/5563/202311072029658.png",loading:"lazy"}})]),a._v(" "),t("h4",{attrs:{id:"真相"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#真相"}},[a._v("#")]),a._v(" 真相")]),a._v(" "),t("p",[a._v("后来某一天，系统又出了其他 Bug，我就去看线上日志，结果这一看，好家伙，这都是啥啊？！")]),a._v(" "),t("p",[t("img",{staticClass:"lazy",attrs:{alt:"","data-src":"https://pic.yupi.icu/5563/202311072029765.png",loading:"lazy"}})]),a._v(" "),t("blockquote",[t("p",[a._v("线上程序日志")])]),a._v(" "),t("p",[a._v("为啥会有这么多问号呢？")]),a._v(" "),t("p",[a._v("哦，中文乱码了，估计是部署这个项目的 Docker 容器缺少中文环境吧。")]),a._v(" "),t("p",[a._v("等等，我突然想到了什么！")]),a._v(" "),t("p",[t("img",{staticClass:"lazy",attrs:{alt:"","data-src":"https://pic.yupi.icu/5563/202311072029256.png",loading:"lazy"}})]),a._v(" "),t("p",[a._v("在中文乱码下，我们很多有意义的中文内容都变成了枯燥的问号，导致无法分辨看到的信息有何不同。那么会不会是这个原因，导致之前我们根据 SQL 语句生成的 key 也相同了呢？")]),a._v(" "),t("p",[a._v("看了下日志，果然，查询一班和二班的 SQL 语句都变成了下面这副模样：")]),a._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("select ????,????,???? \nfrom student\nwhere ???? = '????';\n")])]),a._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[a._v("1")]),t("br"),t("span",{staticClass:"line-number"},[a._v("2")]),t("br"),t("span",{staticClass:"line-number"},[a._v("3")]),t("br")])]),t("p",[a._v("显然，查询条件无论指定为啥，都已经没有意义了，最终查询了同一个缓存，从而取到了同一份数据。")]),a._v(" "),t("p",[a._v("真相大白，之后我在容器的配置文件中补充上对中文环境的支持，再重新构建，就完美解决了~")]),a._v(" "),t("blockquote",[t("p",[a._v("参考博客：https://blog.csdn.net/weixin_39153210/article/details/83617792")])]),a._v(" "),t("p",[a._v("解决 Bug 的那一刻，感觉世界又充满了色彩哈哈哈！")]),a._v(" "),t("hr"),a._v(" "),t("p",[a._v("看来，想要解决 Bug，一定要立足于事实（比如日志等 “证据”），有序排查，灵活分析。有时，你以为的不一定是你以为的！")]),a._v(" "),t("p",[a._v("排查 Bug 虽然头疼，但却能锻炼一个人思考问题的方法，帮他积累到更多经验。对我来说，这波属实不亏~")]),a._v(" "),t("p",[a._v("以上就是本期分享，我是鱼皮，"),t("strong",[a._v("点赞 + 在看")]),a._v(" 还是要求一下的，祝大家都能心想事成、发大财、行大运。")]),a._v(" "),t("p",[t("img",{staticClass:"lazy",attrs:{alt:"","data-src":"https://pic.yupi.icu/5563/202311072029964.png",loading:"lazy"}})])])}),[],!1,null,null,null);t.default=n.exports}}]);